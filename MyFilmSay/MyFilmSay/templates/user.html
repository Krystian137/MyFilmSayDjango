{% include "header.html" %}
{% load static %}

<header
    class="masthead"
    style="background-image: url('{% static 'assets/img/users_main_header.jpg' %}')"
>
    <div class="container position-relative px-4 px-lg-5">
        <div class="row gx-4 gx-lg-5 justify-content-center">
            <div class="col-md-10 col-lg-8 col-xl-7">
                <div class="site-heading">
                    <h1>{{ profile_owner.name }}</h1>
                    <span class="subheading">{{ profile_owner.email }}</span>
                    <span class="subheading">{{ profile_owner.role }}</span>
                </div>
            </div>
        </div>
    </div>
</header>

{% block content %}
{% for movie, data in user_comments.items %}
    <div class="comment-container mx-auto w-75 w-md-50">
        <div class="comment-title">
            ðŸŽ¬ <a href="{% url 'show_movie' movie.id %}">{{ movie.title }}</a>
        </div>

        {% for comment in data.comments %}
            <div class="comment-box" id="comment-{{ comment.id }}">
                <div class="comment-text comment-display-{{ comment.id }}">{{ comment.text|safe }}</div>

                <!-- Edit Form -->
                <div class="edit-form-{{ comment.id }}" style="display: none;">
                    <textarea class="form-control mb-2 edit-textarea" rows="3">{{ comment.text|striptags }}</textarea>
                    <button class="btn btn-success btn-sm save-edit-comment" data-comment-id="{{ comment.id }}">Save</button>
                    <button class="btn btn-secondary btn-sm cancel-edit-comment" data-comment-id="{{ comment.id }}">Cancel</button>
                </div>

                {% if user.is_authenticated %}
                    {% if user.id == comment.author_id %}
                        <button class="btn btn-warning btn-sm edit-comment-btn" data-comment-id="{{ comment.id }}">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    {% endif %}
                    {% if user.is_admin or user.is_moderator or user.id == comment.author_id %}
                        <button class="btn btn-danger btn-sm delete-comment" data-comment-id="{{ comment.id }}">Delete</button>
                    {% endif %}
                {% endif %}

                {% for reply in comment.replies %}
                    <div class="reply-box" id="reply-{{ reply.id }}">
                        <div class="reply-text comment-display-{{ reply.id }}">â†³ {{ reply.reply_text|striptags }}</div>

                        <div class="edit-form-{{ reply.id }}" style="display: none;">
                            <textarea class="form-control mb-2 edit-textarea" rows="2">{{ reply.reply_text|striptags }}</textarea>
                            <button class="btn btn-success btn-sm save-edit-reply" data-reply-id="{{ reply.id }}">Save</button>
                            <button class="btn btn-secondary btn-sm cancel-edit-reply" data-reply-id="{{ reply.id }}">Cancel</button>
                        </div>

                        {% if user.is_authenticated %}
                            {% if user.id == reply.author_id %}
                                <button class="btn btn-warning btn-sm edit-reply-btn" data-reply-id="{{ reply.id }}">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                            {% endif %}
                            {% if user.is_admin or user.is_moderator or user.id == reply.author_id %}
                                <button class="btn btn-danger btn-sm delete-comment" data-comment-id="{{ reply.id }}">Delete</button>
                            {% endif %}
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        {% endfor %}

        {% if not data.comments and data.replies %}
            {% for reply_list in data.replies.values %}
                {% for reply in reply_list %}
                    <div class="reply-box" id="reply-{{ reply.id }}">
                        <div class="reply-text comment-display-{{ reply.id }}">â†³ {{ reply.reply_text|striptags }}</div>

                        <!-- Edit Form -->
                        <div class="edit-form-{{ reply.id }}" style="display: none;">
                            <textarea class="form-control mb-2 edit-textarea" rows="2">{{ reply.reply_text|striptags }}</textarea>
                            <button class="btn btn-success btn-sm save-edit-reply" data-reply-id="{{ reply.id }}">Save</button>
                            <button class="btn btn-secondary btn-sm cancel-edit-reply" data-reply-id="{{ reply.id }}">Cancel</button>
                        </div>

                        {% if user.is_authenticated %}
                            {% if user.id == reply.author_id %}
                                <button class="btn btn-warning btn-sm edit-reply-btn" data-reply-id="{{ reply.id }}">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                            {% endif %}
                            {% if user.is_admin or user.is_moderator or user.id == reply.author_id %}
                                <button class="btn btn-danger btn-sm delete-comment" data-comment-id="{{ reply.id }}">Delete</button>
                            {% endif %}
                        {% endif %}
                    </div>
                {% endfor %}
            {% endfor %}
        {% endif %}
    </div>
{% endfor %}
{% endblock %}

{% include "footer.html" %}